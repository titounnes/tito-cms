<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>e-project-tech.com</title>
        <link rel="shortcut icon" href="/icons/e-project.png" type="image/x-icon" />
        <meta name="viewport" content="width=device-width,minimum-scale=1">
        <meta name="description" content="">
        <meta name="generator" content="Hugo 0.80.0" />
        <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
        <link rel="manifest" href="/manifest.json">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
        <link href="http://fonts.cdnfonts.com/css/temporarium" rel="stylesheet">
        <style>
            body{
                font-family: temporarium;
            }
            #preview{
                border-color: darkslategrey;
                width:100%;
                height:600px;
                overflow-y: auto;
                background-color: rgb(229, 234, 236);
                padding: 10px 10px 10px 10px;
                word-wrap: break-word;
            }
            #editor{
                background-color: rgb(11, 14, 10);
                color:rgb(169, 213, 221);
            }
            #post, #draft{
                max-height: 200px;
                overflow-y: auto;
            }
            input, textarea{
                margin: 5px 5px 5px 5px;
            }
        </style>
        <script>
            // if('serviceWorker' in navigator) {
            //     navigator.serviceWorker
            //         .register('/sw.js?v=7', { scope: '/' })          
            // }
        </script>
    </head>
    <body>
        <header>
            <h1 class="text-center">Tito Editor</h1>
        </header>
        <div class="container">{{ content }}</div>
    </body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown.js/0.5.0/markdown.min.js" crossorigin="anonymous"></script>
    <script>
        editor = document.getElementById('editor')
        preview = document.getElementById('preview')
        var id = '';
        if(preview && editor){
            preview.innerHTML = markdown.toHTML( editor.value )
        }
        if(editor){
            editor.addEventListener('keyup', function(e){
                document.getElementById('alert').hidden = true;
                preview.innerHTML = markdown.toHTML( this.value ) 
            })

            editor.addEventListener('keydown', function(e){
                if (['Tab','Enter'].indexOf(e.key) >=0) {
                    char = {
                        'Tab' : '\t',
                        'Enter' : '\n\n'
                    }
                    e.preventDefault();
                    var start = this.selectionStart;
                    var end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + char[e.key] + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 1;
                }
            })
        }
        submit = document.getElementsByClassName('submit')
        if(submit){
            for(i=0; i< submit.length; i++){
                submit.item(i).addEventListener('click', function(e){
                    e.preventDefault();
                    if(!document.getElementById('title').value){
                        document.getElementById('alert').hidden = false;
                        message.textContent = 'Title must be not null.'
                        return;
                    }
                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4) {
                            message = document.getElementById('message')
                            document.getElementById('alert').hidden = false;
                            if(this.status == 200){
                                output = JSON.parse(this.response)
                                id = output[0].meta.id;
                                document.getElementById('draft').innerHTML = output[1];
                                document.getElementById('post').innerHTML = output[2];
                                message.textContent = 'Changes saved successfully.'
                                document.getElementById('btn-draft').hidden = output[0].meta.draft!='true';
                                document.getElementById('btn-publish').textContent = output[0].meta.draft=='true' ? 'Publish' : 'Update';
                                document.getElementById('btn-unpublish').hidden = output[0].meta.draft=='true';
                            }else if(this.status == 304){
                                message.textContent = 'No data changes..'
                            }
                        }
                    };
                    xhttp.open("POST", '/index.php?r=news', true);
                    var data = new FormData();
                    data.append('id', id);
                    data.append('title', document.getElementById('title').value);
                    data.append('category', document.getElementById('category').value);
                    data.append('tags', document.getElementById('tags').value);
                    data.append('content', document.getElementById('editor').value);
                    data.append('type', this.name);
                    xhttp.send(data)         
                })
            }
        }
        posts = document.getElementsByClassName('posts')
        if(posts){
            for(i=0; i< posts.length; i++){
                posts.item(i).addEventListener('click', function(e){
                    e.preventDefault();
                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            output = JSON.parse(this.response)
                            id = output.meta.id
                            document.getElementById('title').value = output.meta.title;
                            document.getElementById('category').value = output.meta.category;
                            document.getElementById('tags').value = output.meta.tags;
                            editor.value = output.content;
                            preview.innerHTML = markdown.toHTML( output.content )
                            document.getElementById('category').hidden = output.meta.draft=='true';
                            document.getElementById('tags').hidden = output.meta.draft=='true';
                            document.getElementById('btn-draft').hidden = output.meta.draft!='true';
                            document.getElementById('btn-publish').textContent = output.meta.draft=='true' ? 'Publish' : 'Update';
                            document.getElementById('btn-unpublish').hidden = output.meta.draft=='true';
                        }
                    };
                    xhttp.open("GET", '/index.php?r=news&id='+this.getAttribute('href'), true);
                    xhttp.send()
                })
            }
        }
        newPost = document.getElementById('new')
        if(newPost){
            newPost.addEventListener('click', function(e){
                e.preventDefault();
                document.getElementById('title').value = '';
                document.getElementById('editor').value= '';
                document.getElementById('preview').innerHTML = '';
                document.getElementById('category').hidden = true;
                document.getElementById('tags').hidden = true;                
            })
        }
    </script>
</html>    